<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ROVER v1 // MISSION CONTROL</title>
    <style>
        :root {
            --spacex-cyan: #00f2ff;
            --glass: rgba(0, 0, 0, 0.4);
            --border: rgba(255, 255, 255, 0.15);
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', sans-serif;
        }

        .viewport {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #050505;
        }

        #videoPlayer {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            pointer-events: none;
            filter: contrast(1.1) brightness(0.9) saturate(1.2);
        }

        /* FPV LENS EFFECTS */
        .lens-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
            background: radial-gradient(circle, transparent 40%, rgba(0, 0, 0, 0.4) 80%, rgba(0, 0, 0, 0.8) 100%);
        }

        .lens-effects::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        .lens-effects::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 3px, 3px 100%;
        }

        /* HUD LAYOUT */
        .hud-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30px;
            box-sizing: border-box;
        }

        .hud-overlay button,
        .glass-card {
            pointer-events: auto;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--spacex-cyan);
            padding: 12px 18px;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }

        .hud-header,
        .hud-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        /* COMPONENT STATUS STYLING */
        .subsystem-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }

        .stat-label {
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #555;
        }

        .dot.red {
            background: #e74c3c;
            box-shadow: 0 0 8px #e74c3c;
        }

        .dot.green {
            background: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
            animation: blink 1.5s infinite;
        }

        .stat span {
            font-size: 20px;
            font-weight: bold;
            display: block;
            color: #fff;
            text-shadow: 0 0 10px var(--spacex-cyan);
        }

        /* CONTROL CLUSTER */
        .control-cluster {
            display: flex;
            gap: 15px;
        }

        .wasd-controls,
        .arrow-controls {
            display: grid;
            grid-template-columns: repeat(3, 45px);
            gap: 5px;
        }

        button {
            width: 45px;
            height: 45px;
            background: rgba(0, 0, 0, 0.6);
            color: var(--spacex-cyan);
            border: 1px solid var(--spacex-cyan);
            border-radius: 4px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            font-weight: bold;
            transition: all 0.1s ease;
            /* Faster transition for instant feel */
            outline: none;
        }

        /* Lights up when clicked with mouse */
        button:active,
        button.active-glow {
            background: var(--spacex-cyan);
            color: #000;
            box-shadow: 0 0 30px var(--spacex-cyan), 0 0 10px #fff;
            transform: scale(0.95);
        }

        button:hover {
            background: var(--spacex-cyan);
            color: #000;
            box-shadow: 0 0 15px var(--spacex-cyan);
        }

        button:active {
            transform: scale(0.9);
        }

        .rover-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
            filter: drop-shadow(0 0 4px var(--spacex-cyan));
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <div class="viewport">
        <video id="videoPlayer" autoplay muted playsinline></video>

        <!-- <div class="lens-effects"></div> -->

        <div class="hud-overlay">
            <div class="hud-header">
                <!-- <div class="glass-card">REC ● <span style="color:red; animation: blink 1s infinite;">LIVE</span></div> -->
                <div class="glass-card"> Mango Rover V1.0</div>
                <div class="glass-card">CAM_01 // <span id="clock">00:00:00</span></div>
            </div>

            <div class="hud-left" style="position: absolute; left: 30px; top: 120px;">
                <div class="glass-card" style="width: 190px; border-left: 3px solid var(--spacex-cyan);">
                    <div style="font-size: 9px; opacity: 0.6; margin-bottom: 10px;">SUBSYSTEM_CHECK //</div>

                    <div class="subsystem-item">
                        <span class="dot red" id="mainServerDot"></span>
                        <div style="font-size:10px; width:100%; display:flex; justify-content:space-between;">
                            MAIN_SRV <span id="mainServerStatus" style="color:#e74c3c">OFFLINE</span>
                        </div>
                    </div>

                    <div class="subsystem-item">
                        <span class="dot red" id="cameraDot"></span>
                        <div style="font-size:10px; width:100%; display:flex; justify-content:space-between;">
                            CAM_UNIT <span id="cameraStatus" style="color:#e74c3c">OFFLINE</span>
                        </div>
                    </div>

                    <div class="subsystem-item">
                        <span class="dot red" id="motorDot"></span>
                        <div style="font-size:10px; width:100%; display:flex; justify-content:space-between;">
                            DRIVE_MOD <span id="motorStatus" style="color:#e74c3c">HALT</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="hud-footer">
                <div class="glass-card"
                    style="display:flex; flex-direction:column; gap:15px; border-left: 3px solid var(--spacex-cyan); min-width: 280px;">
                    <div style="display:flex; gap:40px;">
                        <div class="stat">SIG <span>98%</span></div>
                        <div class="stat">PWR <span>12.4V</span></div>
                        <div class="stat">DLAY <span id="lat">14ms</span></div>
                    </div>
                    <div
                        style="display:flex; align-items: center; border-top: 1px solid var(--border); padding-top: 10px; gap: 40px;">
                        <div style="width: 50px; height: 50px;">
                            <svg viewBox="0 0 100 100" class="rover-svg">
                                <defs>
                                    <linearGradient id="viewFade" x1="0%" y1="100%" x2="0%" y2="0%">
                                        <stop offset="0%" style="stop-color:var(--spacex-cyan); stop-opacity:0" />
                                        <stop offset="100%" style="stop-color:var(--spacex-cyan); stop-opacity:0.4" />
                                    </linearGradient>
                                </defs>

                                <rect x="35" y="30" width="30" height="40" fill="none" stroke="var(--spacex-cyan)"
                                    stroke-width="2" />
                                <rect x="30" y="35" width="5" height="10" fill="var(--spacex-cyan)" />
                                <rect x="65" y="35" width="5" height="10" fill="var(--spacex-cyan)" />
                                <rect x="30" y="55" width="5" height="10" fill="var(--spacex-cyan)" />
                                <rect x="65" y="55" width="5" height="10" fill="var(--spacex-cyan)" />

                                <g id="cameraGroup"
                                    style="transition: transform 0.2s ease-out; transform-origin: 50px 40px;">
                                    <path d="M50 40 L25 5 L75 5 Z" fill="url(#viewFade)" stroke="none" />

                                    <line x1="25" y1="5" x2="75" y2="5" stroke="var(--spacex-cyan)" stroke-width="1"
                                        opacity="0.5" />

                                    <circle cx="50" cy="40" r="3" fill="var(--spacex-cyan)" />
                                </g>
                            </svg>
                        </div>
                        <div class="stat">PAN <span id="panDisplay">0°</span></div>
                        <div class="stat">TILT <span id="panDisplay">0°</span></div>
                    </div>
                </div>

                <div class="control-cluster">
                    <div class="wasd-controls">
                        <div></div><button id="btn-up-w" onmousedown="drive('up')" onmouseup="stop()">W</button>
                        <div></div>
                        <button id="btn-left-a" onmousedown="drive('left')" onmouseup="stop()">A</button>
                        <button id="btn-down-s" onmousedown="drive('down')" onmouseup="stop()">S</button>
                        <button id="btn-right-d" onmousedown="drive('right')" onmouseup="stop()">D</button>
                    </div>
                    <div class="arrow-controls">
                        <div></div><button id="btn-up-arr" onmousedown="drive('up')" onmouseup="stop()">▲</button>
                        <div></div>
                        <button id="btn-left-arr" onmousedown="drive('left')" onmouseup="stop()">◀</button>
                        <button id="btn-down-arr" onmousedown="drive('down')" onmouseup="stop()">▼</button>
                        <button id="btn-right-arr" onmousedown="drive('right')" onmouseup="stop()">▶</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PI_IP = "rover.tail9d0237.ts.net";
        const video = document.getElementById('videoPlayer');

        // NEW: Tracking for the Pan Angle
        let currentPan = 0;
        const PAN_STEP = 5; // How many degrees to move per click/keypress
        const MAX_PAN = 90; // Limit rotation to 90 degrees each way

        // Function to update the SVG Visuals
        function updatePanUI(angle) {
            const camera = document.getElementById('cameraGroup');
            const label = document.getElementById('panDisplay');

            // Rotate the SVG cone
            camera.style.transform = `rotate(${angle}deg)`;
            // Update the text display
            label.innerText = `${angle}°`;
        }

        async function startWebRTC() {
            try {
                const pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
                pc.addTransceiver('video', { direction: 'recvonly' });
                pc.ontrack = (event) => { video.srcObject = event.streams[0]; };
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                const res = await fetch(`http://${PI_IP}:8889/cam/whep`, {
                    method: 'POST', headers: { 'Content-Type': 'application/sdp' }, body: pc.localDescription.sdp
                });
                const answerSdp = await res.text();
                await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });
            } catch (e) { console.error("Connection Failed", e); }
        }

        // Updated Drive Function with UI feedback
        function drive(dir) {
            fetch(`http://${PI_IP}:3000/api/control/${dir}`, { method: 'POST' });

            // Visual Feedback for Pan
            if (dir === 'left') {
                currentPan = Math.max(currentPan - PAN_STEP, -MAX_PAN);
                updatePanUI(currentPan);
            } else if (dir === 'right') {
                currentPan = Math.min(currentPan + PAN_STEP, MAX_PAN);
                updatePanUI(currentPan);
            }
        }

        function stop() {
            fetch(`http://${PI_IP}:3000/api/control/stop`, { method: 'POST' });
            document.querySelectorAll('button').forEach(b => b.classList.remove('active-glow'));
        }

        const keyMap = {
            'w': 'btn-up-w', 'ArrowUp': 'btn-up-arr',
            'a': 'btn-left-a', 'ArrowLeft': 'btn-left-arr',
            's': 'btn-down-s', 'ArrowDown': 'btn-down-arr',
            'd': 'btn-right-d', 'ArrowRight': 'btn-right-arr'
        };

        window.addEventListener('keydown', (e) => {
            const dirMap = { 'w': 'up', 'a': 'left', 's': 'down', 'd': 'right', 'ArrowUp': 'up', 'ArrowDown': 'down', 'ArrowLeft': 'left', 'ArrowRight': 'right' };
            if (dirMap[e.key]) {
                e.preventDefault();
                drive(dirMap[e.key]);
                const btnId = keyMap[e.key];
                if (btnId) document.getElementById(btnId).classList.add('active-glow');
            }
        });

        window.addEventListener('keyup', (e) => { if (keyMap[e.key]) stop(); });
        startWebRTC();
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

        /**
  * Updates both the dot and the text label for a subsystem
  * @param {string} id - Prefix of the IDs (e.g., 'mainServer')
  * @param {boolean} isOnline - Current state
  * @param {string} onlineText - Text to show when green
  */
        function updateSubsystemUI(id, isOnline, onlineText = "ACTIVE") {
            const dot = document.getElementById(id + 'Dot');
            const label = document.getElementById(id + 'Status');

            if (isOnline) {
                dot.className = 'dot green';
                label.innerText = onlineText;
                label.style.color = '#2ecc71'; // Green text
            } else {
                dot.className = 'dot red';
                label.innerText = "OFFLINE";
                label.style.color = '#e74c3c'; // Red text
            }
        }

        async function runDiagnostics() {
            // 1. Check MAIN_SRV (Express Control API)
            try {
                const res = await fetch(`http://${PI_IP}:3000/api/control/stop`, {
                    method: 'POST',
                    signal: AbortSignal.timeout(2000)
                });
                updateSubsystemUI('mainServer', res.ok, "LINKED");
            } catch (e) {
                updateSubsystemUI('mainServer', false);
            }

            // 2. Check CAM_UNIT (MediaMTX Streaming)
            try {
                const res = await fetch(`http://${PI_IP}:8889/cam/whep`, {
                    method: 'OPTIONS',
                    signal: AbortSignal.timeout(2000)
                });
                // MediaMTX is considered up if it responds to WHEP options
                updateSubsystemUI('camera', res.status < 500, "STREAMING");
            } catch (e) {
                updateSubsystemUI('camera', false);
            }
        }

        // Start the diagnostic loop
        setInterval(runDiagnostics, 3000);
        runDiagnostics();
    </script>
</body>

</html>