services:
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx
    # Use 'host' to give the container direct access to the Pi's network
    network_mode: "host" 
    volumes:
      - ./mediamtx.yml:/mediamtx.yml
    restart: always

  virtual-cam:
    image: lscr.io/linuxserver/ffmpeg:latest
    container_name: virtual-cam
    network_mode: "host" 
    restart: always
    # IMPORTANT: We use 127.0.0.1 because both containers are now on the 'host'
    entrypoint: >
      ffmpeg -re -f lavfi -i "testsrc=size=1280x720:rate=30,format=yuv420p" 
      -c:v libx264 -preset ultrafast -tune zerolatency -pix_fmt yuv420p
      -f rtsp rtsp://127.0.0.1:8554/cam

  dashboard:
    image: node:18-slim
    container_name: rover-dashboard
    working_dir: /app
    volumes:
      - ./dashboard:/app
    ports:
      - "3000:3000"
    command: npm start
    networks:
      - rover-net
    depends_on:
      - mediamtx
    restart: always

networks:
  rover-net:
    driver: bridge